<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignalMatrix Repo | GitHub Portfolio Analyzer</title>
    <link rel="stylesheet" href="static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>SignalMatrix Repo</h1>
                <p>Where Recruiters See Beyond Commits</p>
            </div>
            <button id="settingsToggleBtn"
                style="background: transparent; border: 1px solid var(--border-color); padding: 0.5rem; cursor: pointer;"
                title="Settings">
                ⚙️
            </button>
        </header>

        <section class="settings-section" id="settingsSection"
            style="margin-top: 1rem; border: 1px solid var(--border-color); padding: 1rem; border-radius: 8px; display: none; background: rgba(255, 255, 255, 0.05);">
            <div class="form-group">
                <label for="githubToken">GitHub Personal Access Token (Optional)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="password" id="githubToken" placeholder="Paste your token here..." autocomplete="off"
                        spellcheck="false" style="flex-grow: 1;">
                    <button id="saveTokenBtn" style="white-space: nowrap;">Save</button>
                    <button id="clearTokenBtn"
                        style="background: var(--danger-color); white-space: nowrap; display: none;">Clear</button>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Token is stored <strong>only in your browser (LocalStorage)</strong>. It is never saved to our
                    database.
                </p>
                <p id="tokenStatus" style="font-size: 0.8rem; color: var(--success-color); height: 1.2em;"></p>
            </div>
        </section>

        <section class="input-section" id="inputSection">
            <div class="form-group">
                <label for="username">GitHub Username</label>
                <input type="text" id="username" placeholder="e.g. torvalds" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="resume">Resume Text (Optional - for claim verification)</label>
                <textarea id="resume" rows="5" placeholder="Paste resume text here..."></textarea>
            </div>
            <button id="analyzeBtn">Analyze Profile</button>
        </section>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing signals, rule-based scoring, and AI reasoning in progress...</p>
        </div>

        <section class="report-section" id="reportSection">
            <div class="report-card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem;">
                    <div>
                        <span id="scoreBadge" class="scoreBadge"></span>
                        <h2 id="decisionLabel" style="display: inline; border: none;"></h2>
                    </div>
                    <div style="text-align: right;">
                        <p style="color: var(--text-secondary);">Hiring Risk Index</p>
                        <h3 id="riskLabel"></h3>
                    </div>
                </div>

                <div class="grid">
                    <div>
                        <h2>Executive Summary</h2>
                        <p id="execSummary"></p>
                    </div>
                    <div>
                        <h2>Recruiter Reasoning</h2>
                        <p id="recruiterReasoning" style="font-style: italic;"></p>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="report-card">
                    <h2>Signal Breakdown</h2>
                    <ul id="breakdownList"></ul>
                </div>
                <div class="report-card">
                    <h2>Strong Signals</h2>
                    <ul id="strongSignals"></ul>
                </div>
            </div>

            <div class="report-card red-flags">
                <h2>Red Flags</h2>
                <div id="redFlagsContent"></div>
            </div>

            <div class="grid">
                <div class="report-card">
                    <h2>Performance Benchmarks</h2>
                    <p><strong>Complexity:</strong> <span id="complexityClass"></span></p>
                    <p><strong>Maturity Trend:</strong> <span id="maturityTrend"></span></p>
                    <p><strong>Collaboration Score:</strong> <span id="collabScore"></span></p>
                    <p><strong>Benchmark Position:</strong> <span id="benchmarkPos"></span></p>
                </div>
                <div class="report-card">
                    <h2>Resume Verification</h2>
                    <p id="resumeVerification"></p>
                </div>
            </div>

            <div class="report-card">
                <h2>30-Day Improvement Roadmap</h2>
                <div id="roadmapContent" class="grid"
                    style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"></div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button onclick="window.location.reload()" style="background: var(--border-color);">New
                    Analysis</button>
            </div>
        </section>

    </div>

    <script>
        const TOKEN_KEY = 'gh_token_local';
        const MASKED_TOKEN = '********';

        document.addEventListener('DOMContentLoaded', () => {
            loadTokenState();
        });

        const tokenInput = document.getElementById('githubToken');
        const saveBtn = document.getElementById('saveTokenBtn');
        const clearBtn = document.getElementById('clearTokenBtn');
        const statusMsg = document.getElementById('tokenStatus');
        const settingsSection = document.getElementById('settingsSection');
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');

        settingsToggleBtn.addEventListener('click', () => {
            if (settingsSection.style.display === 'none') {
                settingsSection.style.display = 'block';
            } else {
                settingsSection.style.display = 'none';
            }
        });

        // Security: Prevent copy
        tokenInput.addEventListener('copy', (e) => {
            e.preventDefault();
            alert('Copying the token is disabled for security.');
        });

        // Security: Prevent context menu
        tokenInput.addEventListener('contextmenu', (e) => e.preventDefault());

        saveBtn.addEventListener('click', () => {
            const token = tokenInput.value.trim();
            if (!token) return;

            // Simple validation to check if it looks like a token
            if (!token.startsWith('gh') && token.length < 20) {
                if (!confirm("This doesn't look like a standard GitHub token. Save anyway?")) return;
            }

            localStorage.setItem(TOKEN_KEY, token);
            tokenInput.value = ''; // Clear strict value
            loadTokenState();
            showStatus('Token saved securely to browser LocalStorage!', 'success');
        });

        clearBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to remove the token from this browser?')) {
                localStorage.removeItem(TOKEN_KEY);
                loadTokenState();
                showStatus('Token removed from browser.', 'warning');
            }
        });

        function loadTokenState() {
            const storedToken = localStorage.getItem(TOKEN_KEY);
            if (storedToken) {
                // Show masked version
                const last4 = storedToken.slice(-4);
                tokenInput.placeholder = `Saved: ${MASKED_TOKEN}${last4}`;
                saveBtn.innerText = 'Update Token';
                clearBtn.style.display = 'block';
            } else {
                tokenInput.placeholder = 'Paste your token here...';
                saveBtn.innerText = 'Save Token';
                clearBtn.style.display = 'none';
            }
        }

        function showStatus(msg, type) {
            statusMsg.innerText = msg;
            statusMsg.style.color = type === 'success' ? 'var(--success-color)' : 'var(--warning-color)';
            setTimeout(() => { statusMsg.innerText = ''; }, 3000);
        }

        document.getElementById('analyzeBtn').addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const resume_text = document.getElementById('resume').value.trim();

            if (!username) {
                alert('Please enter a GitHub username.');
                return;
            }

            // UI State Change
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none'; // Hide settings during analysis
            document.getElementById('loading').style.display = 'block';

            try {
                const headers = { 'Content-Type': 'application/json' };

                // Retrieve token from LocalStorage if available
                const storedToken = localStorage.getItem(TOKEN_KEY);
                if (storedToken) {
                    headers['Authorization'] = `Bearer ${storedToken}`;
                }

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ username, resume_text })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }

                const data = await response.json();
                renderReport(data);
            } catch (error) {
                alert('Error: ' + error.message);
                document.getElementById('inputSection').style.display = 'block';
                document.getElementById('settingsSection').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        });

        function renderReport(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('reportSection').style.display = 'block';

            // Score & Decision
            const scoreBadge = document.getElementById('scoreBadge');
            scoreBadge.innerText = data.overall_score;
            scoreBadge.className = 'score-badge ' +
                (data.recruiter_decision === 'Strong Shortlist' ? 'strong' :
                    data.recruiter_decision === 'Borderline' ? 'borderline' : 'ready');

            document.getElementById('decisionLabel').innerText = data.recruiter_decision;
            document.getElementById('riskLabel').innerText = data.hiring_risk;
            document.getElementById('riskLabel').style.color =
                data.hiring_risk === 'High' ? 'var(--danger-color)' :
                    data.hiring_risk === 'Medium' ? 'var(--warning-color)' : 'var(--success-color)';

            // Summaries
            document.getElementById('execSummary').innerText = data.executive_summary;
            document.getElementById('recruiterReasoning').innerText = data.recruiter_reasoning;
            document.getElementById('resumeVerification').innerText = data.resume_verification;

            // Breakdown
            const breakdownList = document.getElementById('breakdownList');
            for (const [key, value] of Object.entries(data.signal_breakdown)) {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}/10`;
                breakdownList.appendChild(li);
            }

            // Signals
            const strongSignals = document.getElementById('strongSignals');
            data.strong_signals.forEach(s => {
                const li = document.createElement('li');
                li.innerText = s;
                strongSignals.appendChild(li);
            });

            // Red Flags
            const redFlagsDiv = document.getElementById('redFlagsContent');
            ['critical', 'moderate', 'minor'].forEach(severity => {
                if (data.red_flags[severity] && data.red_flags[severity].length > 0) {
                    const h4 = document.createElement('h4');
                    h4.innerText = severity.toUpperCase();
                    h4.style.color = severity === 'critical' ? 'var(--danger-color)' : 'var(--warning-color)';
                    redFlagsDiv.appendChild(h4);
                    const ul = document.createElement('ul');
                    data.red_flags[severity].forEach(f => {
                        const li = document.createElement('li');
                        li.innerText = f;
                        ul.appendChild(li);
                    });
                    redFlagsDiv.appendChild(ul);
                }
            });

            // Benchmarks
            document.getElementById('complexityClass').innerText = data.complexity_classification;
            document.getElementById('maturityTrend').innerText = data.maturity_trend;
            document.getElementById('collabScore').innerText = data.collaboration_score + '/10';
            document.getElementById('benchmarkPos').innerText = data.benchmark_position;

            // Roadmap
            const roadmapDiv = document.getElementById('roadmapContent');
            if (data.improvement_roadmap) {
                for (const [week, plan] of Object.entries(data.improvement_roadmap)) {
                    const div = document.createElement('div');
                    div.style.padding = '1rem';
                    div.style.border = '1px solid var(--border-color)';
                    div.style.borderRadius = '8px';
                    div.innerHTML = `<h3>${week.toUpperCase()}</h3><p>${plan}</p>`;
                    roadmapDiv.appendChild(div);
                }
            }
        }
    </script>
</body>

</html>